
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Garbage Collection and How to Avoid It - prime[31] blog - Unity tips, tricks and random thoughts</title>
  <meta name="author" content="Mike Desaro">

  
  <meta name="description" content="Managed languages (like C#) have often been touted as the panacea of programming. We no longer need to be concerned with memory management. Memory &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.prime31.com/recyclerkit">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="prime[31] blog - Unity tips, tricks and random thoughts" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">prime[31] blog - Unity tips, tricks and random thoughts</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.prime31.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Garbage Collection and How to Avoid It</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-05T17:16:05-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:16 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Managed languages (like C#) have often been touted as the panacea of programming. We no longer need to be concerned with memory management. Memory leaks are a thing of the past. Retain/release/delete is banashed to the bowels of hell. The garbage collector (GC from here on out) will take care of all the ugly details of memory management for us.</p>

<!-- more -->


<p>The reality of the situtation is that we almost need to be <em>even more careful</em> in a managed environment. All control of memory management is now out of our hands and we have no choice but to deal with the GC and its madness. To make matters even worse, Unity ships with an <strong>absolutely ancient</strong> GC. If you are making a mobile game it will undoubtedly end up being a battle with the GC.</p>

<h2>So, What Actually Happens at Runtime?</h2>

<p>In simplified terms, as you allocate more and more memory eventually the GC gets to its limit and it kicks in a collection. While the GC is collecting everything freezes until it is complete. On desktop platforms it isn&rsquo;t terrible as long as you have a couple milliseconds per frame to spare. On mobile and most consoles it is a guaranteed frame rate stutter. If you continue to allocate every frame you end up with endless stutters.</p>

<h2>What Causes Allocations?</h2>

<p>From all of the code I have seen, the main culprits are calling Instantiate at runtime and senseless string usage. There are plenty of other sources but these are the two biggest offenders. Conveniently, these happen to also be completely under our own control. We already touched on strings with the <a href="/constants-generator-kit/">ConstantsGeneratorKit post</a> so give that a look if you haven&rsquo;t seen it yet. Abolishing Instantiate calls requires a bit more foresight and some discipline. It is just too easy to stick calls to Instantiate in our code sometimes. What we need is a solution that is just as simple as Instantiate/Destroy.</p>

<h2>Enter Object Pools</h2>

<p>What is an object pool (as defined by <a href="http://stackoverflow.com/users/37213/duffymo">duffymo</a>)?</p>

<blockquote><p>&ldquo;An object pool is a collection of a particular object that an application will create and keep on hand for those situations where creating each instance is expensive.&rdquo;</p></blockquote>

<p>What this boils down to for a Unity game is that we do all of our Instantiate calls at level load time. Object pools are the tool that we use to do this. There are plenty of tutorials and sample code including a great video right on the <a href="http://unity3d.com/learn/tutorials/modules/beginner/live-training-archive/object-pooling">Unity Learn website</a>. As is the case with all of the core feature tools we also have an open source object pool available in our *Kit family.</p>

<h2>RecyclerKit</h2>

<p><img src="/images/posts/garbageCollector/RecyclerKitInspector.png" alt="" /> <a href="https://github.com/prime31/RecyclerKit">RecyclerKit</a> aims to take the pain out of using an object pool. It includes a simple inspector that lets you drag-and-drop any prefab or GameObject in your scene to create an object pool. From there, you just replace your Instantiate calls with <code>TrashMan.spawn</code> and replace your Destroy calls with <code>TrashMan.despawn/despawnAfterDelay</code>. Of course, not everyone wants to use the inspector and sometimes you don&rsquo;t know what you want to stick in an object pool until runtime so you can create your recycle bins anytime. Below is a snippet showing how to create and use a recycle bin at runtime:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// create a new recycle bin</span>
</span><span class='line'><span class="kt">var</span> <span class="n">recycleBin</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TrashManRecycleBin</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">prefab</span> <span class="p">=</span> <span class="n">somePrefabOrGameObjectReference</span>
</span><span class='line'>    <span class="c1">// any other options can be placed here</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">TrashMan</span><span class="p">.</span><span class="n">manageRecycleBin</span><span class="p">(</span> <span class="n">recycleBin</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// usage is the same as with a recycle bin created with the inspector</span>
</span><span class='line'><span class="kt">var</span> <span class="n">newObj</span> <span class="p">=</span> <span class="n">TrashMan</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span> <span class="n">somePrefabOrGameObjectReference</span> <span class="p">);</span>
</span><span class='line'><span class="n">TrashMan</span><span class="p">.</span><span class="n">despawnAfterDelay</span><span class="p">(</span> <span class="n">newObj</span><span class="p">,</span> <span class="m">5f</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>All the options we have ever needed over the last couple years have been added so RecyclerKit should cover just about all use cases. Options include the total number of objects to preallocate, total objects to create if we hit the recycle bin limit, automatically recycle ParticleSystems (based on system.duration + system.startLifetime), use a hard limit (do not allocate any objects once the recycle bin is empty) and automatic culling (destroy instances above a certain amount). Go grab a copy and avoid the GC monster in your games!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mike Desaro</span></span>

      




<time class='entry-date' datetime='2015-01-05T17:16:05-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:16 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/grass2d" title="Previous Post: Interactive 2D Foliage">&laquo; Interactive 2D Foliage</a>
      
      
        <a class="basic-alignment right" href="/simple-value-mapping" title="Next Post: Simple Value Mapping">Simple Value Mapping &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mike Desaro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
