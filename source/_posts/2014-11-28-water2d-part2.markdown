---
layout: post
title: "Modeling 2D Water with Springs: Part 2"
date: 2014-11-30 22:09:42 -0800
categories:
permalink: water2d-part2
published: false
---


In part 1, all the groundwork for setting up the water simulation was laid. We have springs attached to the top verts of the water plane which always want to remain in their neutral position. Once a force is applied to the springs they will oscillate back and forth based on the dampening and tension constants that are passed in.

<!-- more -->

At this point we have a Mesh (with a handy BoxCollider2D making it super easy to position and shape the water plane in the editor) and our WaterColumn struct ready to go but nothing is happening yet. We need to implement an Update method and start applying some forces to the springs. There are different ways to get creative with this part so I'll just touch on this particular implementation. Right now the springs don't affect each other at all which would make the water look pretty silly if we applied a force to any of our springs. We need to take into account what our neighbor springs are doing. The way that was accomplished is see if the neighbor springs are above or below the current spring and if so apply a force in that direction based on how far it is from the current spring and a made up constant. Something like this (which shows only the spring to our right): `spring[i].velocity += konstant * ( spring[i].currentHeight - spring[i+1].currentHeight)`.


The final piece of the simulation is detecting when something falls in the water and applying an appropriate force. This is where our BoxCollider2D (which is set as a trigger) comes in handy. We use OnTriggerEnter2D to detect anything hitting the water then use it's velocity and mass to affect our springs. ![](/images/posts/water2d/splash.png) The easy way to do this is to just find the nearest spring and apply the force to that spring. We don't take the easy way out here though so we are going to do this the right way. What we will do is use the Bounds of the object that fell in the water to determine exactly which springs should be affected. Once we find all the springs we just divide the force by affected spring count to spread out the force and apply it to each spring by adding to it's velocity.


That's all there is to the simulation. There is still more we can do to make it look better though for sure. The first gif showed what the water looks like with minimal springs/verts and only simple vertex colors. That is the low-end version of the water. Adding a refraction shader would give it a pretty neat look. You could also apply a blur shader that moves around and varies itself over time. The gif below uses a displacement map with a GrabPass to give provide a bit of life to the water. Unfortunately, the low quality gif doesn't let you see the true beauty of the effect.


<iframe src="http://gfycat.com/ifr/FreshGroundedAmericanmarten" frameborder="0" scrolling="no" width="846" height="478" style="-webkit-backface-visibility: hidden;-webkit-transform: scale(1);" ></iframe>