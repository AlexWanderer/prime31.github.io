
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PropEnumEvents (Wtf?) - prime[31] blog - Unity tips, tricks and random thoughts</title>
  <meta name="author" content="Mike Desaro">

  
  <meta name="description" content="I often use StateKit (a simple, object-based finite state machine implementation) for all kinds of state management. It gets used for enemy AI, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.prime31.com/prop-enum-events">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="prime[31] blog - Unity tips, tricks and random thoughts" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">prime[31] blog - Unity tips, tricks and random thoughts</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.prime31.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">PropEnumEvents (Wtf?)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T21:05:54-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:05 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I often use <a href="https://github.com/prime31/StateKit">StateKit</a> (a simple, object-based finite state machine implementation) for all kinds of state management. It gets used for enemy AI, player controllers, menus and just about everywhere else. In a recent project that was not very well defined (to be honest, it was made almsot completely on the fly) I needed a super flexible way to deal with a hierarchial state machine. The solution presented in this post is what I ended up using and it has been dubbed the PropEnumEvent system.</p>

<!-- more -->


<h2>Defining the Problem</h2>

<p>Let&rsquo;s say you have a game with a main menu and some submenus. Maybe you have no idea how many menus and you need a nice, flexible way to deal with them. We&rsquo;ll start things off by creating an enum that has a value for each menu/state in the game.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">enum</span> <span class="n">GameState</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">MainMenu</span><span class="p">,</span>
</span><span class='line'>  <span class="n">LevelSelectMenu</span><span class="p">,</span>
</span><span class='line'>  <span class="n">MultiPlayerMenu</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Map</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To add a bit of spice to the discussion, lets add some substates for the GameState.Map value:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">enum</span> <span class="n">MapState</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Editing</span><span class="p">,</span>
</span><span class='line'>  <span class="n">PrePlay</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Playing</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Paused</span><span class="p">,</span>
</span><span class='line'>  <span class="n">PlayerWon</span><span class="p">,</span>
</span><span class='line'>  <span class="n">PlayerDied</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we were to whip up a quick diagram for what we have so far it might look something like this:</p>

<p><img src="/images/posts/propEnumEvents/state-flow.png" alt="" /></p>

<p>We can only be on one screen at any given time and the Map screen has several different sub states. Nothing groundbreaking here so far. We want to use these enums to drive the entire state of the game from launch until completion. We are going to need to show/hide UI, HUD elements, control enemy AI state etc. There is no limit to how far you can take it.</p>

<h2>Decouple the Pieces!</h2>

<p>I personally hate tightly coupled code. It makes changing things, adding features and refactoring a huge PITA. <a href="https://github.com/prime31/MessageKit">MessageKit</a> solves a lot of the tight coupling problems and it will be used for the PropEnumEvent system since I always already have it in whatever project I am working on. The meat of the solution is incredibly simple but quite powerful (and quite similar to <a href="https://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanged%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396">INotifyPropertyChanged</a> or <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">KVO</a>). All we are going to do is wire up a property that when changed uses MessageKit to post a message with the new enum value (note that plain old .NET events would work fine as well for this if you don&rsquo;t use MessageKit). You&rsquo;ll see in the code below the message is posted <em>before</em> the value is set. The reason for that is that sometimes the system listening for the message needs to know the previous state (UI for example so that it can do proper transitions). When the message is received the receiver will get the new state and they can access the old state via the <em>state</em> property.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="n">GameState</span> <span class="n">_state</span><span class="p">;</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">GameState</span> <span class="n">state</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">get</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_state</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">set</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">_state</span> <span class="p">==</span> <span class="k">value</span> <span class="p">)</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">MessageKit</span><span class="p">&lt;</span><span class="n">GameState</span><span class="p">&gt;.</span><span class="n">post</span><span class="p">(</span> <span class="n">Messages</span><span class="p">.</span><span class="n">gameStateChanged</span><span class="p">,</span> <span class="k">value</span> <span class="p">);</span>
</span><span class='line'>      <span class="n">_state</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">MapState</span> <span class="n">_state</span><span class="p">;</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">MapState</span> <span class="n">state</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">get</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_state</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">set</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">_state</span> <span class="p">==</span> <span class="k">value</span> <span class="p">)</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">MessageKit</span><span class="p">&lt;</span><span class="n">GameState</span><span class="p">&gt;.</span><span class="n">post</span><span class="p">(</span> <span class="n">Messages</span><span class="p">.</span><span class="n">mapStateChanged</span><span class="p">,</span> <span class="k">value</span> <span class="p">);</span>
</span><span class='line'>      <span class="n">_state</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it. Nothing more to it. In that little snippet of code we end up with a powerful, decoupled system to control our games. Adding new enum values as the game grows in complexity is no problem. Code can set the enum and trigger the message at any time easily. Some example message listeners from the project this was used in are HUD (activates/deactivates features based on state), canvas (hides/shows menus with animations based on state), player (enables/disables self, jumps to spawn point, increments death count).</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mike Desaro</span></span>

      




<time class='entry-date' datetime='2015-03-27T21:05:54-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:05 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/making-playerprefs-sane" title="Previous Post: Making PlayerPrefs Sane">&laquo; Making PlayerPrefs Sane</a>
      
      
        <a class="basic-alignment right" href="/anatomy-of-a-tween-lib" title="Next Post: Anatomy of a Tween Library">Anatomy of a Tween Library &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mike Desaro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
